////////////////////////////////////////////////////////////////
///                                                          ///
///                   yeomané¡¹ç›®æž„å»ºé€»è¾‘                       ///
///                   ç»§æ‰¿è‡ªyeoman-generatorç±»                ///
///                   åœ¨ç”Ÿå‘½å‘¨æœŸå›žè°ƒä¸­æ³¨å…¥åŠ¨æ€é€»è¾‘               ///
///                                                          ///
////////////////////////////////////////////////////////////////

const path = require('path');
const fs = require('fs');
const util = require('util');
const chalk = require('chalk');
const generators = require('yeoman-generator');
const figlet = require('figlet');
const ora = require('ora');

module.exports = class app extends generators {
  /**
   * ç»§æ‰¿yeoman-generator
   * èŽ·å–ç”Ÿå‘½å‘¨æœŸhook
   */

  constructor(args, opts) {
    super(args, opts);
    this.appName = path.basename(process.cwd());
    this.appAuthor = 'wulimark';
  };

  /**
   * è„šæ‰‹æž¶åˆå§‹åŒ–
   */

  initializing() {
    figlet('ZEPTO PRO', (err, data) => {
        if (err) {
            this.log(chalk.red('Something went wrong...'));
            console.dir(err);
            return;
        }
        this.log(data);
    });
    this.log(chalk.green('ðŸ¦„  è„šæ‰‹æž¶é¡¹ç›®å¼€å§‹æž„å»ºå‡†å¤‡...è¯·ç¨å€™...'));
    const spinner = ora('è¿›å…¥æž„å»ºæµç¨‹').succeed();
  };

  /**
   * ç”¨æˆ·å‚æ•°è¾“å…¥
   */

  prompting() {
    let questions = [
      {
        type: 'input',
        name: 'projectName',
        message: 'è¯·è¾“å…¥é¡¹ç›®åç§°',
        default: this.appName
      },
      {
        type: 'input',
        name: 'projectVersion',
        message: 'é¡¹ç›®ç‰ˆæœ¬å·',
        default: '1.0.0'
      },
      {
        type: 'list',
        name: 'mode',
        message: 'è¯·é€‰æ‹©åŒ…å«çš„å­é¡¹ç›®ç±»åž‹',
        choices: [
          {
            name: 'ç”ŸæˆmobileåŠpcé¡¹ç›®',
            value: 0,
            checked: 0
          },
          {
            name: 'åªç”Ÿæˆmobileé¡¹ç›®',
            value: 1
          },
          {
            name: 'åªç”Ÿæˆpcé¡¹ç›®',
            value: 2
          }
        ]
      }
    ];
    return this.prompt(questions)
    .then(function(answers){
      for(let item in answers){
          //bindç»‘å®šä¸Šä¸‹æ–‡, promptingè¾“å…¥å‚æ•°æ·»åŠ åˆ°this, æ–¹ä¾¿åŽç»­é€»è¾‘ç¼–å†™
          answers.hasOwnProperty(item) && (this[item] = answers[item]);
      }
      const spinner = ora('æž„å»ºå‚æ•°è¾“å…¥å®Œæ¯•, è¿›å…¥æž¶æž„é…ç½®ç”Ÿæˆæµç¨‹').succeed();
    }.bind(this));
  };

  /**
   * é…ç½®ç”Ÿæˆ
   */

  configuring() {
    let defaultSettings = this.fs.readJSON(this.templatePath('package.json'));
    let packageSettings = {
      name: this.projectName,
      private: true,
      version: this.projectVersion,
      description: `${this.projectName} - Generated by generator-jquery-mobile-pc`,
      main: 'index.js',
      scripts: defaultSettings.scripts,
      repository: defaultSettings.repository || '',
      keywords: [],
      author: this.appAuthor,
      devDependencies: defaultSettings.devDependencies,
      dependencies: defaultSettings.dependencies,
      jest: defaultSettings.jest || '',
      babel: defaultSettings.babel || '',
      eslintConfig: defaultSettings.eslintConfig || '',
      proxy: defaultSettings.proxy || ''
    };
    this.fs.writeJSON(this.destinationPath('package.json'), packageSettings);
    const spinner = ora('æž¶æž„é…ç½®ç”Ÿæˆå®Œæ¯•, è¿›å…¥æž¶æž„ç›®å½•ç”Ÿæˆæµç¨‹').succeed();
  };

  /**
   * ç›®å½•ç”Ÿæˆ
   */

  async writing() {
    const readdir = util.promisify(fs.readdir);
    const files = await readdir(this.templatePath());
    const uncopy_files = [
      'dist',
      'node_modules',
      'package-lock.json',
      'package.json',
    ];
    let copy_files = files.filter(item => uncopy_files.indexOf(item) < 0);
    copy_files.map(item => this.fs.copy(
      this.templatePath(item),
      this.destinationPath(item)
    ));
    this.async();
  };

  /**
   * å®‰è£…ä¾èµ–
   */

  install() {
    if (this.mode) {
      let dir = ['mobile', 'pc'];
      removeDir(this.destinationPath(`mock/${dir[dir.length - this.mode]}`));
      removeDir(this.destinationPath(`src/${dir[dir.length - this.mode]}`));
    }
    const spinner = ora('æž¶æž„ç›®å½•ç”Ÿæˆå®Œæ¯•, è¿›å…¥ä¾èµ–å®‰è£…æµç¨‹').succeed();

    /**
     * é€’å½’åˆ é™¤ç›®å½•
     */

    function removeDir(dir) {
      let files = fs.readdirSync(dir);
      files.map((item, i) => {
        let _path = path.join(dir, files[i]);
        let stat = fs.statSync(_path);
        if (stat.isDirectory()) {
          removeDir(_path);
        } else {
          fs.unlinkSync(_path);
        }
      });
      fs.rmdirSync(dir);
    };

    this.installDependencies({
      bower: false,
      npm: true,
      callback: function() {
        const spinner = ora('npmä¾èµ–å®‰è£…å®Œæ¯•').succeed();
      }
    });
  };
 
  /**
   * æž„å»ºå®Œæˆ
   */

  end() {
    const spinner = ora('è„šæ‰‹æž¶æž„å»ºå®Œæ¯•').succeed();
    figlet('KKL FE TEAM', (err, data) => {
        if (err) {
            this.log(chalk.red('Something went wrong...'));
            console.dir(err);
            return;
        }
        this.log(chalk.green(data));
    });
  };
};